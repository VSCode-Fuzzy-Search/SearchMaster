name: CI

on:
    workflow_run:
        workflows: ['Preflight']
        types:
            - completed

jobs:
    read-preflight-results:
        name: Read Preflight Results
        runs-on: ubuntu-latest
        steps:
            - id: read-preflight-results
              uses: edumserrano/share-jobs-data@v1
              with:
                  command: read-data-different-workflow
                  run-id: ${{ github.event.workflow_run.id }} # We need to specify the run id of the workflow that shared the data.

        outputs:
            COVERAGE_ARTIFACT_EXISTS: ${{ steps.read-preflight-results.outputs.coverage-artifact-exists }}

    test:
        name: Test on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        needs: read-preflight-results
        # Only run the tests if the coverage artifact does not exist.
        if: needs.read-preflight-results.outputs.COVERAGE_ARTIFACT_EXISTS != true
        strategy:
            matrix:
                os: [macos-latest, ubuntu-latest, windows-latest]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: 'Install Node.js'
              uses: actions/setup-node@v4
              with:
                  node-version-file: '.nvmrc'
                  cache: 'npm'

            - name: Install Dependencies
              run: npm install

            # In headless Linux CI machines XVFB is required to run VS Code, so if Linux is the current OS run the tests in an XVFB enabled environment.
            - name: Run Tests
              run: ${{ runner.os == 'Linux' && 'xvfb-run -a npm run coverage' || 'npm run coverage' }}

            # For specifically pull requests, we want to comment the coverage results on the PR.
            - name: Comment Coverage
              if: github.event_name == 'pull_request'
              uses: sidx1024/report-nyc-coverage-github-action@v1.2.7
              with:
                  coverage_file: coverage/coverage-summary.json

            # Upload the coverage summary JSON file as an artifact.
            - name: Upload Coverage Summary JSON
              # We don't want to upload the coverage summary JSON file multiple times.
              if: runner.os == 'Linux'
              uses: actions/upload-artifact@v4
              with:
                  name: coverage
                  path: coverage/coverage-summary.json
